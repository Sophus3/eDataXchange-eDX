# GTM Dynamic Script Injection Template

## Overview

This repository contains a **eDataXchange(eDX) custom Tag Template** for **Google Tag Manager (GTM)**. The template dynamically constructs a script URL based on the **'brand'** and **'market'** parameters, and attempts to inject the script into the webpage if the necessary permissions are met. It provides error handling, logging, and success/failure callbacks to help with debugging and monitoring.

The script URL is built by combining the **brand** and **market** parameters dynamically, and if the permissions are valid, the script is injected into the page.
We also add a **service ID** as an added layer of security. This ID is checked within the actual script to ensure requests are made from a valid file/domain.

## Features
- Dynamic URL construction based on the 'brand' and 'market' parameters.
- Script injection into the webpage with error handling and success/failure callbacks.
- Logging support for debugging, depending on the debug flag.
- Permission check before injecting the script.
- Customizable for different brands and markets.

## Version Information

- **Version**: 1.0.0
- **Release Date**: January 14, 2025
- **Description**: Dynamic script injection template for Google Tag Manager (GTM).
- **Developer Notes**: This template is intended to be used in a GTM custom tag template for injecting an external script and handling success, failure, and permission mismatches.

## Prerequisites

This template is designed to be used in **Google Tag Manager (GTM)**. Before using it, ensure that you have the following:
- A GTM account and container.
- Access to GTM's custom tag configuration.
- Correct permissions to execute the tag.
- The `brand` and `market` parameters should be passed dynamically from the GTM environment.

## Installation

To integrate this template into your Google Tag Manager container, follow these steps:

1. **Add the template**:
    - Open your GTM account.
    - Go to the **Templates** section and select **Search Gallery**
    - Open the search field and enter "Sophus3".
    - Select the "eDataXchange (eDX) Base Tag" template and click **Add To Workspace**

2. **View the template**:
    - From the **Templates** section, select the template
   
3. **Set Up The Tag**:
    - In the **Tags** section click **New**
    - Give the tag a name **eDX Script** for example
    - Select **Tag Configuration** and from the choices list, under **Custom** you will find the **eDataXchange (eDX) Base Tag** template, select it.
    - Enter your **Brand Name**, **Market** and **Service ID** as supplied by Sophus3.
    - (Optional) Select **Enable console log messages** to see console log messages in the browser developer tools.
    - NOTE: The tag should fire on every page. We recommend using the **All Pages** trigger.
   
4. **Adding the trigger**:
    - From within the tag, select **Triggering** and then select **All Pages**
    - NOTE: you may wish to define your own trigger

5. **Publish the Container**:
    - Once you've configured the tag and trigger, and tested in preview mode. Publish the GTM container.

## How It Works

### Dynamic URL Construction

- The URL of the script is generated by combining the `brand` and `market` parameters.
- Example URL format:  
  `https://scripts.sophus3.com/s3s/{brand}/{market}/s3edx.min.js`
- The `brand` and `market` values are retrieved dynamically from the GTM data layer or custom variables.

### Permissions Check

Before injecting the script into the page, the template checks if the permissions match using the `queryPermission` function. If the permissions are valid, the script is injected. Otherwise, the script will not be injected, and a failure is logged.

### Success/Failure Callbacks

- **onSuccess()**: Called when the script is successfully loaded.
- **onFailure()**: Called if the script fails to load or if there is a permission mismatch.

These callbacks trigger **GTM's custom success and failure functions** (`gtmOnSuccess` and `gtmOnFailure`), ensuring that the tag execution status is correctly reported.

## Example Code (Summary)

```javascript
/**
 * Utility function to safely retrieve and process dynamic parameters from the 'data' object.
 * @param {string} param - The parameter to retrieve from 'data'.
 * @param {string} defaultValue - The default value if the parameter is undefined.
 * @returns {string} - The processed parameter value or the default value.
 */
// Require the necessary APIs
const logToConsole = require('logToConsole');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');

// Get the URL the user input into the text field
const url = "https://scripts.sophus3.com/s3s/"+data.brand+"/"+data.market+"/s3edx.min.js?serviceid="+data.service_id;

// If the user chose to log debug output, initialize the logging method
const log = data.debug ? logToConsole : (() => {});

log('Sophus3: Loading script from ' + url);

// If the script loaded successfully, log a message and signal success
const onSuccess = () => {
   log('Sophus3: eDX script loaded successfully.');
   data.gtmOnSuccess();
};

// If the script fails to load, log a message and signal failure
const onFailure = () => {
   log('Sophus3: eDX script load failed.');
   data.gtmOnFailure();
};

// inject the script with the onSuccess and onFailure methods as callbacks.
if (queryPermission('inject_script', url)) {
   injectScript(url, onSuccess, onFailure);
} else {
   log('Sophus3: eDX script load failed due to permissions mismatch. Please inform Sophus3!');
   data.gtmOnFailure();
}
```

## Debugging

- To enable console logging, ensure that the ` Enable console log messages.` flag is `checked` in the eDX tag.
- Logs will be printed to the console (if available), helping you debug the script injection process.

## License

This project is licensed under the **Apache 2.0 License** - see the [LICENSE](./LICENSE) file for details.

